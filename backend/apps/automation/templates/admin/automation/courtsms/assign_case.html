{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='automation' %}">è‡ªåŠ¨åŒ–å·¥å…·</a>
    &rsaquo; <a href="{% url 'admin:automation_courtsms_changelist' %}">æ³•é™¢çŸ­ä¿¡</a>
    &rsaquo; <a href="{% url 'admin:automation_courtsms_change' sms.id %}">çŸ­ä¿¡ #{{ sms.id }}</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="content-main">
    <h1>ğŸ”— {{ title }}</h1>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- çŸ­ä¿¡ä¿¡æ¯ -->
    <div class="module">
        <h2>ğŸ“± çŸ­ä¿¡ä¿¡æ¯</h2>
        <div class="sms-info">
            <div class="info-row">
                <strong>çŸ­ä¿¡ID:</strong> {{ sms.id }}
            </div>
            <div class="info-row">
                <strong>å½“å‰çŠ¶æ€:</strong> 
                <span class="status-{{ sms.status }}">{{ sms.get_status_display }}</span>
            </div>
            <div class="info-row">
                <strong>æ”¶åˆ°æ—¶é—´:</strong> {{ sms.received_at }}
            </div>
            <div class="info-row">
                <strong>çŸ­ä¿¡å†…å®¹:</strong>
                <div class="sms-content">{{ sms.content }}</div>
            </div>
            {% if sms.case_numbers %}
            <div class="info-row">
                <strong>æå–çš„æ¡ˆå·:</strong>
                <ul class="extracted-info">
                    {% for case_number in sms.case_numbers %}
                        <li>{{ case_number }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            {% if sms.party_names %}
            <div class="info-row">
                <strong>æå–çš„å½“äº‹äºº:</strong>
                <ul class="extracted-info">
                    {% for party_name in sms.party_names %}
                        <li>{{ party_name }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- æ¡ˆä»¶é€‰æ‹©è¡¨å• -->
    <div class="module">
        <h2>ğŸ¯ é€‰æ‹©æ¡ˆä»¶</h2>
        <form method="post" id="assign-case-form">
            {% csrf_token %}
            
            <div class="form-section">
                <label for="case-search">ğŸ” æœç´¢æ¡ˆä»¶:</label>
                <input type="text" id="case-search" placeholder="è¾“å…¥æ¡ˆä»¶åç§°ã€æ¡ˆå·æˆ–å½“äº‹äººå§“åè¿›è¡Œæœç´¢..." 
                       style="width: 100%; padding: 8px; margin-bottom: 10px;">
                <div id="search-results" style="display: none; border: 1px solid #ddd; border-radius: 4px; max-height: 300px; overflow-y: auto; background: white; margin-top: 5px;">
                    <!-- AJAX æœç´¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
                <div id="search-loading" style="display: none; padding: 10px; text-align: center; color: #666;">
                    ğŸ”„ æœç´¢ä¸­...
                </div>
            </div>
            
            <div class="form-section">
                <label for="id_case_id" class="required">é€‰æ‹©æ¡ˆä»¶:</label>
                <select name="case_id" id="id_case_id" required style="width: 100%; padding: 8px;">
                    <option value="">è¯·é€‰æ‹©ä¸€ä¸ªæ¡ˆä»¶...</option>
                </select>
                <p class="help">é€‰æ‹©è¦å…³è”çš„æ¡ˆä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨åˆ›å»ºæ¡ˆä»¶æ—¥å¿—å¹¶ç»‘å®šæ–‡ä¹¦</p>
            </div>
            
            <div class="submit-row">
                <input type="submit" value="âœ… ç¡®è®¤æŒ‡å®š" class="default" />
                <a href="{% url 'admin:automation_courtsms_change' sms.id %}" class="button cancel-link">å–æ¶ˆ</a>
            </div>
        </form>
    </div>
    
    <!-- æ¨èæ¡ˆä»¶ -->
    {% if suggested_cases %}
    <div class="module">
        <h2>ğŸ’¡ æ¨èæ¡ˆä»¶ï¼ˆåŸºäºæ¡ˆå·å’Œå½“äº‹äººåŒ¹é…ï¼‰</h2>
        <div class="case-list">
            {% for case in suggested_cases %}
            <div class="case-item suggested" data-case-id="{{ case.id }}">
                <div class="case-header">
                    <strong>{{ case.name }}</strong>
                    <span class="case-id">#{{ case.id }}</span>
                </div>
                <div class="case-details">
                    {% if case.case_numbers.all %}
                        <div><strong>æ¡ˆå·:</strong> 
                            {% for cn in case.case_numbers.all %}
                                {{ cn.case_number }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% if case.parties.all %}
                        <div><strong>å½“äº‹äºº:</strong>
                            {% for party in case.parties.all %}
                                {{ party.client.name }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div><strong>åˆ›å»ºæ—¶é—´:</strong> {{ case.created_at|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="case-actions">
                    <button type="button" class="button select-case" data-case-id="{{ case.id }}">é€‰æ‹©æ­¤æ¡ˆä»¶</button>
                    <a href="{% url 'admin:cases_case_change' case.id %}" target="_blank" class="button">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="module">
        <h2>ğŸ’¡ æ¨èæ¡ˆä»¶</h2>
        <p style="color: #666; padding: 15px;">
            {% if sms.party_names or sms.case_numbers %}
                æœªæ‰¾åˆ°åŒ¹é…çš„æ¨èæ¡ˆä»¶ã€‚è¯·åœ¨ä¸‹æ–¹æœç´¢æˆ–é€‰æ‹©æœ€è¿‘çš„æ¡ˆä»¶ã€‚
            {% else %}
                çŸ­ä¿¡ä¸­æœªæå–åˆ°æ¡ˆå·æˆ–å½“äº‹äººä¿¡æ¯ï¼Œæ— æ³•è‡ªåŠ¨æ¨èæ¡ˆä»¶ã€‚
            {% endif %}
        </p>
    </div>
    {% endif %}
    
    <!-- æœ€è¿‘æ¡ˆä»¶ -->
    {% if recent_cases %}
    <div class="module">
        <h2>ğŸ“… æœ€è¿‘åˆ›å»ºçš„æ¡ˆä»¶</h2>
        <div class="case-list">
            {% for case in recent_cases %}
            <div class="case-item recent" data-case-id="{{ case.id }}">
                <div class="case-header">
                    <strong>{{ case.name }}</strong>
                    <span class="case-id">#{{ case.id }}</span>
                </div>
                <div class="case-details">
                    {% if case.case_numbers.all %}
                        <div><strong>æ¡ˆå·:</strong> 
                            {% for cn in case.case_numbers.all %}
                                {{ cn.case_number }}{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div><strong>åˆ›å»ºæ—¶é—´:</strong> {{ case.created_at|date:"Y-m-d H:i" }}</div>
                </div>
                <div class="case-actions">
                    <button type="button" class="button select-case" data-case-id="{{ case.id }}">é€‰æ‹©æ­¤æ¡ˆä»¶</button>
                    <a href="{% url 'admin:cases_case_change' case.id %}" target="_blank" class="button">æŸ¥çœ‹è¯¦æƒ…</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="module">
        <h2>ğŸ“… æœ€è¿‘åˆ›å»ºçš„æ¡ˆä»¶</h2>
        <p style="color: #666; padding: 15px;">
            æš‚æ— å¯ç”¨çš„æ¡ˆä»¶æ•°æ®ã€‚è¯·æ£€æŸ¥ç³»ç»Ÿä¸­æ˜¯å¦å­˜åœ¨æ¡ˆä»¶è®°å½•ã€‚
        </p>
    </div>
    {% endif %}
</div>

<style>
.alert {
    padding: 10px 15px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
}

.alert-success {
    color: #3c763d;
    background-color: #dff0d8;
    border-color: #d6e9c6;
}

.alert-error {
    color: #a94442;
    background-color: #f2dede;
    border-color: #ebccd1;
}

.sms-info {
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 4px;
}

.info-row {
    margin-bottom: 10px;
}

.sms-content {
    background-color: #fff;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-top: 5px;
    font-family: monospace;
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
}

.extracted-info {
    margin: 5px 0 0 20px;
}

.status-pending_manual {
    color: orange;
    font-weight: bold;
}

.form-section {
    margin-bottom: 20px;
}

.form-section label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
}

.help {
    color: #666;
    font-size: 12px;
    margin-top: 5px;
}

.case-list {
    display: grid;
    gap: 15px;
}

.case-item {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 15px;
    background-color: #fff;
    transition: border-color 0.2s;
}

.case-item:hover {
    border-color: #007cba;
}

.case-item.suggested {
    border-left: 4px solid #28a745;
}

.case-item.recent {
    border-left: 4px solid #007cba;
}

.case-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.case-id {
    color: #666;
    font-size: 12px;
}

.case-details {
    margin-bottom: 15px;
    font-size: 14px;
}

.case-details div {
    margin-bottom: 5px;
}

.case-actions {
    display: flex;
    gap: 10px;
}

.select-case {
    background-color: #28a745 !important;
    color: white !important;
}

.select-case:hover {
    background-color: #218838 !important;
}

.submit-row {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
}

.cancel-link {
    margin-left: 10px;
}

#case-search {
    border: 1px solid #ddd;
    border-radius: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const caseSearch = document.getElementById('case-search');
    const caseSelect = document.getElementById('id_case_id');
    const selectButtons = document.querySelectorAll('.select-case');
    const caseItems = document.querySelectorAll('.case-item');
    
    // æ”¶é›†æ‰€æœ‰æ¡ˆä»¶æ•°æ®
    const allCases = [];
    caseItems.forEach(item => {
        const caseId = item.dataset.caseId;
        if (!caseId) return; // è·³è¿‡æ²¡æœ‰IDçš„é¡¹ç›®
        
        const caseNameElement = item.querySelector('.case-header strong');
        const caseName = caseNameElement ? caseNameElement.textContent.trim() : '';
        
        const caseNumberElements = item.querySelectorAll('.case-details div');
        let caseNumbers = '';
        let parties = '';
        
        caseNumberElements.forEach(div => {
            const text = div.textContent || '';
            if (text.includes('æ¡ˆå·:')) {
                caseNumbers = text.replace('æ¡ˆå·:', '').trim();
            } else if (text.includes('å½“äº‹äºº:')) {
                parties = text.replace('å½“äº‹äºº:', '').trim();
            }
        });
        
        // æ„å»ºæœç´¢æ–‡æœ¬ï¼ŒåŒ…å«æ¡ˆä»¶åç§°ã€æ¡ˆå·ã€å½“äº‹äºº
        const searchText = (caseName + ' ' + caseNumbers + ' ' + parties).toLowerCase();
        
        allCases.push({
            id: caseId,
            name: caseName,
            caseNumbers: caseNumbers,
            parties: parties,
            searchText: searchText
        });
    });
    
    // åˆå§‹åŒ–ä¸‹æ‹‰æ¡†
    function updateCaseSelect(cases = allCases) {
        caseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªæ¡ˆä»¶...</option>';
        cases.forEach(case => {
            const option = document.createElement('option');
            option.value = case.id;
            option.textContent = `${case.name} (ID: ${case.id})`;
            caseSelect.appendChild(option);
        });
    }
    
    updateCaseSelect();
    
    // AJAX æœç´¢åŠŸèƒ½
    let searchTimeout;
    const searchResults = document.getElementById('search-results');
    const searchLoading = document.getElementById('search-loading');
    
    caseSearch.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        if (searchTerm === '') {
            // æ˜¾ç¤ºæ‰€æœ‰åŸå§‹æ¡ˆä»¶
            searchResults.style.display = 'none';
            caseItems.forEach(item => {
                if (item.dataset.caseId) {
                    item.style.display = 'block';
                }
            });
            updateCaseSelect();
            return;
        }
        
        // å…ˆè¿›è¡Œæœ¬åœ°æœç´¢ï¼ˆå³æ—¶å“åº”ï¼‰
        performLocalSearch(searchTerm);
        
        // å»¶è¿Ÿè¿›è¡Œ AJAX æœç´¢ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
        searchTimeout = setTimeout(() => {
            performAjaxSearch(searchTerm);
        }, 500);
    });
    
    function performLocalSearch(searchTerm) {
        const keywords = searchTerm.toLowerCase().split(/\s+/).filter(k => k.length > 0);
        
        const filteredCases = allCases.filter(case => {
            return keywords.every(keyword => 
                case.searchText.includes(keyword) ||
                case.name.toLowerCase().includes(keyword) ||
                case.caseNumbers.toLowerCase().includes(keyword) ||
                case.parties.toLowerCase().includes(keyword)
            );
        });
        
        // æ›´æ–°æ˜¾ç¤º
        caseItems.forEach(item => {
            const caseId = item.dataset.caseId;
            if (!caseId) {
                item.style.display = 'none';
                return;
            }
            
            const shouldShow = filteredCases.some(case => case.id === caseId);
            item.style.display = shouldShow ? 'block' : 'none';
        });
        
        updateCaseSelect(filteredCases);
    }
    
    function performAjaxSearch(searchTerm) {
        if (searchTerm.length < 2) return; // è‡³å°‘2ä¸ªå­—ç¬¦æ‰è¿›è¡Œ AJAX æœç´¢
        
        searchLoading.style.display = 'block';
        searchResults.style.display = 'none';
        
        const searchUrl = `{% url 'admin:automation_courtsms_search_cases' sms.id %}?q=${encodeURIComponent(searchTerm)}`;
        
        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                searchLoading.style.display = 'none';
                
                if (data.error) {
                    console.error('æœç´¢é”™è¯¯:', data.error);
                    return;
                }
                
                displaySearchResults(data.cases);
                updateCaseSelectFromAjax(data.cases);
            })
            .catch(error => {
                searchLoading.style.display = 'none';
                console.error('AJAX æœç´¢å¤±è´¥:', error);
            });
    }
    
    function displaySearchResults(cases) {
        if (cases.length === 0) {
            searchResults.innerHTML = '<div style="padding: 10px; color: #666;">æœªæ‰¾åˆ°åŒ¹é…çš„æ¡ˆä»¶</div>';
            searchResults.style.display = 'block';
            return;
        }
        
        let html = '';
        cases.forEach(case => {
            const caseNumbers = case.case_numbers.join(', ');
            const parties = case.parties.join(', ');
            
            html += `
                <div class="search-result-item" data-case-id="${case.id}" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                    <div style="font-weight: bold;">${case.name} <span style="color: #666; font-size: 12px;">#${case.id}</span></div>
                    ${caseNumbers ? `<div style="font-size: 12px; color: #666;">æ¡ˆå·: ${caseNumbers}</div>` : ''}
                    ${parties ? `<div style="font-size: 12px; color: #666;">å½“äº‹äºº: ${parties}</div>` : ''}
                    <div style="font-size: 12px; color: #999;">åˆ›å»ºæ—¶é—´: ${case.created_at}</div>
                </div>
            `;
        });
        
        searchResults.innerHTML = html;
        searchResults.style.display = 'block';
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        searchResults.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                const caseId = this.dataset.caseId;
                const caseName = this.querySelector('div').textContent.split('#')[0].trim();
                
                // é€‰æ‹©æ¡ˆä»¶
                caseSelect.value = caseId;
                
                // é«˜äº®é€‰ä¸­çš„æ¡ˆä»¶
                caseItems.forEach(caseItem => {
                    caseItem.style.backgroundColor = caseItem.dataset.caseId === caseId ? '#e7f3ff' : '#fff';
                });
                
                // éšè—æœç´¢ç»“æœ
                searchResults.style.display = 'none';
                caseSearch.value = caseName;
                
                // æ»šåŠ¨åˆ°è¡¨å•
                document.getElementById('assign-case-form').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            });
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f0f0f0';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'white';
            });
        });
    }
    
    function updateCaseSelectFromAjax(cases) {
        caseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸€ä¸ªæ¡ˆä»¶...</option>';
        cases.forEach(case => {
            const option = document.createElement('option');
            option.value = case.id;
            option.textContent = `${case.name} (ID: ${case.id})`;
            caseSelect.appendChild(option);
        });
    }
    
    // é€‰æ‹©æ¡ˆä»¶æŒ‰é’®
    selectButtons.forEach(button => {
        button.addEventListener('click', function() {
            const caseId = this.dataset.caseId;
            caseSelect.value = caseId;
            
            // é«˜äº®é€‰ä¸­çš„æ¡ˆä»¶
            caseItems.forEach(item => {
                item.style.backgroundColor = item.dataset.caseId === caseId ? '#e7f3ff' : '#fff';
            });
            
            // æ»šåŠ¨åˆ°è¡¨å•
            document.getElementById('assign-case-form').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        });
    });
    
    // è¡¨å•æäº¤ç¡®è®¤
    document.getElementById('assign-case-form').addEventListener('submit', function(e) {
        const selectedCaseId = caseSelect.value;
        if (!selectedCaseId) {
            e.preventDefault();
            alert('è¯·é€‰æ‹©ä¸€ä¸ªæ¡ˆä»¶');
            return;
        }
        
        const selectedCase = allCases.find(case => case.id === selectedCaseId);
        if (selectedCase && !confirm(`ç¡®è®¤è¦å°†çŸ­ä¿¡å…³è”åˆ°æ¡ˆä»¶"${selectedCase.name}"å—ï¼Ÿ\n\nè¿™å°†è§¦å‘åç»­çš„æ–‡ä¹¦é‡å‘½åå’Œé£ä¹¦æ¨é€æµç¨‹ã€‚`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}