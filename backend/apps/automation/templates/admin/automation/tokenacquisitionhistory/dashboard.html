{% extends "admin/base_site.html" %}
{% load i18n admin_urls static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .stat-card.success { border-left-color: #28a745; }
        .stat-card.warning { border-left-color: #ffc107; }
        .stat-card.danger { border-left-color: #dc3545; }
        .stat-card.info { border-left-color: #17a2b8; }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .table-container table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table-container th,
        .table-container td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table-container th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        
        .time-range-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .time-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .action-buttons {
            margin-bottom: 20px;
        }
        
        .action-buttons .button {
            margin-right: 10px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="breadcrumbs">
        <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
        &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
        &rsaquo; <a href="{% url 'admin:automation_tokenacquisitionhistory_changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
        &rsaquo; {{ title }}
    </div>

    <h1>{{ title }}</h1>
    
    <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
    <div class="action-buttons">
        <a href="{% url 'admin:automation_tokenacquisitionhistory_changelist' %}" class="button default">
            ğŸ“‹ æŸ¥çœ‹è¯¦ç»†è®°å½•
        </a>
        <a href="{% url 'admin:organization_accountcredential_changelist' %}" class="button">
            ğŸ”‘ ç®¡ç†è´¦å·å‡­è¯
        </a>
        <a href="{% url 'admin:automation_courttoken_changelist' %}" class="button">
            ğŸ« æŸ¥çœ‹TokençŠ¶æ€
        </a>
    </div>

    <!-- æ ¸å¿ƒç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_records }}</div>
            <div class="stat-label">ğŸ“Š æ€»è·å–æ¬¡æ•°</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-number">{{ success_records }}</div>
            <div class="stat-label">âœ… æˆåŠŸæ¬¡æ•°</div>
        </div>
        
        <div class="stat-card {% if success_rate >= 80 %}success{% elif success_rate >= 50 %}warning{% else %}danger{% endif %}">
            <div class="stat-number">{{ success_rate|floatformat:1 }}%</div>
            <div class="stat-label">ğŸ“ˆ æ€»ä½“æˆåŠŸç‡</div>
        </div>
        
        <div class="stat-card info">
            <div class="stat-number">{{ performance_stats.avg_duration|floatformat:1 }}s</div>
            <div class="stat-label">â±ï¸ å¹³å‡è€—æ—¶</div>
        </div>
    </div>

    <!-- æ—¶é—´èŒƒå›´ç»Ÿè®¡ -->
    <div class="table-container">
        <h2>ğŸ• æ—¶é—´èŒƒå›´ç»Ÿè®¡</h2>
        <table>
            <thead>
                <tr>
                    <th>æ—¶é—´èŒƒå›´</th>
                    <th>è·å–æ¬¡æ•°</th>
                    <th>æˆåŠŸæ¬¡æ•°</th>
                    <th>æˆåŠŸç‡</th>
                    <th>è¿›åº¦æ¡</th>
                </tr>
            </thead>
            <tbody>
                {% for period, stats in time_stats.items %}
                <tr>
                    <td>
                        {% if period == '1h' %}æœ€è¿‘1å°æ—¶
                        {% elif period == '24h' %}æœ€è¿‘24å°æ—¶
                        {% elif period == '7d' %}æœ€è¿‘7å¤©
                        {% elif period == '30d' %}æœ€è¿‘30å¤©
                        {% endif %}
                    </td>
                    <td>{{ stats.total }}</td>
                    <td>{{ stats.success }}</td>
                    <td>
                        <span style="color: {% if stats.rate >= 80 %}#28a745{% elif stats.rate >= 50 %}#ffc107{% else %}#dc3545{% endif %}; font-weight: bold;">
                            {{ stats.rate|floatformat:1 }}%
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ stats.rate }}%;"></div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- è¶‹åŠ¿å›¾è¡¨ -->
    <div class="chart-container">
        <h2>ğŸ“ˆ æœ€è¿‘7å¤©è¶‹åŠ¿</h2>
        <canvas id="trendChart" width="400" height="200"></canvas>
    </div>

    <!-- çŠ¶æ€åˆ†å¸ƒ -->
    <div class="table-container">
        <h2>ğŸ“Š çŠ¶æ€åˆ†å¸ƒ</h2>
        <table>
            <thead>
                <tr>
                    <th>çŠ¶æ€</th>
                    <th>æ•°é‡</th>
                    <th>å æ¯”</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in status_stats %}
                <tr>
                    <td>
                        {% if stat.status == 'success' %}âœ… æˆåŠŸ
                        {% elif stat.status == 'failed' %}âŒ å¤±è´¥
                        {% elif stat.status == 'timeout' %}â° è¶…æ—¶
                        {% elif stat.status == 'network_error' %}ğŸŒ ç½‘ç»œé”™è¯¯
                        {% elif stat.status == 'captcha_error' %}ğŸ”¤ éªŒè¯ç é”™è¯¯
                        {% elif stat.status == 'credential_error' %}ğŸ”‘ å‡­è¯é”™è¯¯
                        {% else %}{{ stat.status }}
                        {% endif %}
                    </td>
                    <td>{{ stat.count }}</td>
                    <td>
                        {% widthratio stat.count total_records 100 as percentage %}
                        {{ percentage|floatformat:1 }}%
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ç½‘ç«™ç»Ÿè®¡ -->
    <div class="table-container">
        <h2>ğŸŒ ç½‘ç«™ç»Ÿè®¡</h2>
        <table>
            <thead>
                <tr>
                    <th>ç½‘ç«™</th>
                    <th>æ€»æ¬¡æ•°</th>
                    <th>æˆåŠŸæ¬¡æ•°</th>
                    <th>æˆåŠŸç‡</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in site_stats %}
                <tr>
                    <td>{{ stat.site_name }}</td>
                    <td>{{ stat.total }}</td>
                    <td>{{ stat.success }}</td>
                    <td>
                        {% widthratio stat.success stat.total 100 as site_rate %}
                        <span style="color: {% if site_rate >= 80 %}#28a745{% elif site_rate >= 50 %}#ffc107{% else %}#dc3545{% endif %}; font-weight: bold;">
                            {{ site_rate|floatformat:1 }}%
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- è´¦å·ç»Ÿè®¡ -->
    <div class="table-container">
        <h2>ğŸ‘¤ è´¦å·ç»Ÿè®¡ï¼ˆTop 10ï¼‰</h2>
        <table>
            <thead>
                <tr>
                    <th>è´¦å·</th>
                    <th>æ€»æ¬¡æ•°</th>
                    <th>æˆåŠŸæ¬¡æ•°</th>
                    <th>æˆåŠŸç‡</th>
                    <th>å¹³å‡è€—æ—¶</th>
                </tr>
            </thead>
            <tbody>
                {% for stat in account_stats %}
                <tr>
                    <td>{{ stat.account }}</td>
                    <td>{{ stat.total }}</td>
                    <td>{{ stat.success }}</td>
                    <td>
                        {% widthratio stat.success stat.total 100 as acc_rate %}
                        <span style="color: {% if acc_rate >= 80 %}#28a745{% elif acc_rate >= 50 %}#ffc107{% else %}#dc3545{% endif %}; font-weight: bold;">
                            {{ acc_rate|floatformat:1 }}%
                        </span>
                    </td>
                    <td>
                        {% if stat.avg_duration %}
                            <span style="color: {% if stat.avg_duration < 10 %}#28a745{% elif stat.avg_duration < 30 %}#ffc107{% else %}#dc3545{% endif %};">
                                {{ stat.avg_duration|floatformat:1 }}s
                            </span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- æ€§èƒ½æŒ‡æ ‡ -->
    {% if performance_stats.avg_duration %}
    <div class="table-container">
        <h2>âš¡ æ€§èƒ½æŒ‡æ ‡</h2>
        <table>
            <thead>
                <tr>
                    <th>æŒ‡æ ‡</th>
                    <th>æ•°å€¼</th>
                    <th>è¯„çº§</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>å¹³å‡è€—æ—¶</td>
                    <td>{{ performance_stats.avg_duration|floatformat:2 }}ç§’</td>
                    <td>
                        {% if performance_stats.avg_duration < 10 %}
                            <span style="color: #28a745; font-weight: bold;">ğŸš€ ä¼˜ç§€</span>
                        {% elif performance_stats.avg_duration < 30 %}
                            <span style="color: #ffc107; font-weight: bold;">âš¡ è‰¯å¥½</span>
                        {% else %}
                            <span style="color: #dc3545; font-weight: bold;">ğŸŒ éœ€ä¼˜åŒ–</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>æœ€å¿«è€—æ—¶</td>
                    <td>{{ performance_stats.min_duration|floatformat:2 }}ç§’</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>æœ€æ…¢è€—æ—¶</td>
                    <td>{{ performance_stats.max_duration|floatformat:2 }}ç§’</td>
                    <td>-</td>
                </tr>
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<script>
// è¶‹åŠ¿å›¾è¡¨
const trendData = {{ trend_data|safe }};
const ctx = document.getElementById('trendChart').getContext('2d');

new Chart(ctx, {
    type: 'line',
    data: {
        labels: trendData.map(d => d.date),
        datasets: [{
            label: 'è·å–æ¬¡æ•°',
            data: trendData.map(d => d.total),
            borderColor: '#007bff',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            tension: 0.4
        }, {
            label: 'æˆåŠŸæ¬¡æ•°',
            data: trendData.map(d => d.success),
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'æœ€è¿‘7å¤©Tokenè·å–è¶‹åŠ¿'
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
setInterval(() => {
    // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°é¡µé¢
    location.reload();
}, 5 * 60 * 1000);
</script>
{% endblock %}