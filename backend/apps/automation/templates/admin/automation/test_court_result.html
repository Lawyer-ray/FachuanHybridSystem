{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">é¦–é¡µ</a>
    &rsaquo; <a href="{% url 'admin:automation_testcourt_changelist' %}">æµ‹è¯•æ³•é™¢ç³»ç»Ÿ</a>
    &rsaquo; æµ‹è¯•ç™»å½•
</div>
{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 20px auto;">
    <h1>{{ title }}</h1>
    
    <!-- å‡­è¯ä¿¡æ¯ -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h2 style="margin-top: 0;">å‡­è¯ä¿¡æ¯</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <tr>
                <td style="padding: 8px; font-weight: bold; width: 150px;">ç½‘ç«™åç§°:</td>
                <td style="padding: 8px;">{{ credential.site_name }}</td>
            </tr>
            <tr>
                <td style="padding: 8px; font-weight: bold;">URL:</td>
                <td style="padding: 8px;">
                    <a href="{{ credential.url }}" target="_blank">{{ credential.url }}</a>
                </td>
            </tr>
            <tr>
                <td style="padding: 8px; font-weight: bold;">è´¦å·:</td>
                <td style="padding: 8px;">{{ credential.account }}</td>
            </tr>
            <tr>
                <td style="padding: 8px; font-weight: bold;">å¾‹å¸ˆ:</td>
                <td style="padding: 8px;">{{ credential.lawyer.real_name }} ({{ credential.lawyer.username }})</td>
            </tr>
        </table>
    </div>
    
    <!-- æµ‹è¯•ç»“æœ -->
    <div style="background: {% if result.success %}#d4edda{% else %}#f8d7da{% endif %}; 
                padding: 20px; border-radius: 8px; margin-bottom: 20px; 
                border: 2px solid {% if result.success %}#28a745{% else %}#dc3545{% endif %};">
        <h2 style="margin-top: 0; color: {% if result.success %}#155724{% else %}#721c24{% endif %};">
            {% if result.success %}
                âœ… ç™»å½•æˆåŠŸ
            {% else %}
                âŒ ç™»å½•å¤±è´¥
            {% endif %}
        </h2>
        <p style="font-size: 16px; margin: 10px 0;">
            <strong>æ¶ˆæ¯:</strong> {{ result.message }}
        </p>
        
        {% if result.token %}
        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 4px;">
            <p style="margin: 0 0 10px 0; font-weight: bold; color: #155724;">ğŸ”‘ æ•è·çš„ Token:</p>
            <code style="background: #fff; padding: 10px; border-radius: 4px; display: block; 
                        word-break: break-all; font-size: 12px; color: #333;">{{ result.token }}</code>
            <p style="margin: 10px 0 0 0; font-size: 13px; color: #155724;">
                âœ… Token å·²ä¿å­˜åˆ° Redis å’Œæ•°æ®åº“ï¼Œå…¶ä»–è„šæœ¬å¯ä»¥é€šè¿‡ <code>TokenService.get_token()</code> è·å–
            </p>
        </div>
        {% else %}
        <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.7); border-radius: 4px;">
            <p style="margin: 0; font-size: 13px; color: #856404;">
                âš ï¸ æœªæ•è·åˆ° Tokenï¼Œå¯èƒ½ç™»å½•æ¥å£æœªè¿”å› Token æˆ–æ ¼å¼ä¸åŒ¹é…
            </p>
        </div>
        {% endif %}
    </div>
    
    <!-- æ‰§è¡Œæ—¥å¿— -->
    <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
        <h2 style="margin-top: 0;">æ‰§è¡Œæ—¥å¿—</h2>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; 
                    font-size: 13px; max-height: 300px; overflow-y: auto;">
            {% for log in result.logs %}
                <div style="margin: 5px 0;">{{ log }}</div>
            {% endfor %}
        </div>
    </div>
    
    <!-- é”™è¯¯è¯¦æƒ… -->
    {% if result.error %}
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ffc107;">
        <h2 style="margin-top: 0; color: #856404;">é”™è¯¯è¯¦æƒ…</h2>
        <pre style="background: #fff; padding: 15px; border-radius: 4px; overflow-x: auto; 
                    font-size: 12px; border: 1px solid #ddd;">{{ result.error }}</pre>
    </div>
    {% endif %}
    
    <!-- æˆªå›¾ -->
    {% if result.screenshots %}
    <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
        <h2 style="margin-top: 0;">è°ƒè¯•æˆªå›¾</h2>
        <p style="color: #666; margin-bottom: 15px;">æœ€æ–°çš„ 5 å¼ æˆªå›¾ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰</p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            {% for screenshot in result.screenshots %}
                <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                    <a href="{{ screenshot }}" target="_blank">
                        <img src="{{ screenshot }}" 
                             style="width: 100%; height: auto; display: block; cursor: pointer;"
                             alt="æˆªå›¾">
                    </a>
                    <div style="padding: 8px; background: #f8f9fa; font-size: 12px; color: #666;">
                        ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Token ä½¿ç”¨ç¤ºä¾‹ -->
    {% if result.success and result.token %}
    <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
        <h2 style="margin-top: 0;">ğŸ“ Token ä½¿ç”¨ç¤ºä¾‹</h2>
        <p style="color: #666; margin-bottom: 15px;">åœ¨å…¶ä»–è„šæœ¬ä¸­ä½¿ç”¨æ•è·çš„ Tokenï¼š</p>
        <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; 
                    font-size: 12px; color: #333;"><code>from apps.automation.services.scraper.core.token_service import TokenService

# è·å– Token
token_service = TokenService()
token = token_service.get_token("{{ credential.site_name }}", "{{ credential.account }}")

if token:
    # ä½¿ç”¨ Token è°ƒç”¨ API
    import requests
    headers = {"Authorization": f"Bearer {token}"}
    response = requests.get("https://api.example.com/data", headers=headers)
    print(response.json())
else:
    print("Token ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ")</code></pre>
    </div>
    {% endif %}
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <a href="{% url 'admin:automation_testcourt_changelist' %}" 
           class="button" 
           style="padding: 10px 20px; background: #417690; color: white; text-decoration: none; 
                  border-radius: 4px; display: inline-block; margin-right: 10px;">
            â† è¿”å›åˆ—è¡¨
        </a>
        
        <a href="{% url 'admin:organization_accountcredential_change' credential.id %}" 
           class="button" 
           style="padding: 10px 20px; background: #6c757d; color: white; text-decoration: none; 
                  border-radius: 4px; display: inline-block; margin-right: 10px;">
            ç¼–è¾‘å‡­è¯
        </a>
        
        <a href="{% url 'admin:automation_testcourt_test_login' credential.id %}" 
           class="button" 
           style="padding: 10px 20px; background: #28a745; color: white; text-decoration: none; 
                  border-radius: 4px; display: inline-block;">
            ğŸ”„ é‡æ–°æµ‹è¯•
        </a>
    </div>
    
    <!-- æç¤ºä¿¡æ¯ -->
    <div style="margin-top: 30px; padding: 15px; background: #e7f3ff; border-radius: 4px; border-left: 4px solid #2196F3;">
        <h3 style="margin-top: 0; color: #1976D2;">ğŸ’¡ æç¤º</h3>
        <ul style="margin: 10px 0; padding-left: 20px; color: #555;">
            <li>æµ‹è¯•è¿‡ç¨‹ä¸­ä¼šæ‰“å¼€æµè§ˆå™¨çª—å£ï¼Œè¯·ä¸è¦å…³é—­</li>
            <li>æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰§è¡Œç™»å½•æ“ä½œï¼Œå®Œæˆåä¼šåœç•™ 10 ç§’ä¾›è§‚å¯Ÿ</li>
            <li>ç™»å½•æˆåŠŸåä¼šè‡ªåŠ¨æ•è· Token å¹¶ä¿å­˜åˆ° Redis å’Œæ•°æ®åº“</li>
            <li>Token é»˜è®¤æœ‰æ•ˆæœŸä¸º 1 å°æ—¶ï¼Œè¿‡æœŸåéœ€è¦é‡æ–°ç™»å½•</li>
            <li>æ‰€æœ‰æˆªå›¾å’Œè°ƒè¯•ä¿¡æ¯ä¿å­˜åœ¨ <code>media/automation/screenshots/</code></li>
            <li>éªŒè¯ç å›¾ç‰‡ä¿å­˜åœ¨ <code>media/automation/debug/</code></li>
            <li>å¦‚æœéªŒè¯ç è¯†åˆ«å¤±è´¥ï¼Œä¼šè‡ªåŠ¨é‡è¯•æœ€å¤š 5 æ¬¡</li>
        </ul>
    </div>
</div>
{% endblock %}
