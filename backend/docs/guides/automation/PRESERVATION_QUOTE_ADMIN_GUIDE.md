# 财产保全询价 Admin 后台使用指南

## 概述

财产保全询价 Admin 后台提供了完整的询价任务管理功能，包括创建任务、查看任务列表、查看报价详情、执行任务和重试失败任务。

## 访问路径

访问 Django Admin 后台：`/admin/automation/preservationquote/`

## 功能说明

### 1. 创建询价任务

#### 步骤：

1. 点击右上角的 "增加财产保全询价" 按钮
2. 填写以下必填字段：
   - **保全金额**: 需要保全的财产金额（例如：100000.00）
   - **企业/法院ID**: 法院系统中的企业或法院标识（例如：440100）
   - **分类ID**: 保全分类ID，即 cPid（例如：1）
   - **凭证ID**: 关联的账号凭证ID（从 `/admin/organization/accountcredential/` 获取）
3. 点击 "保存" 创建任务

#### 注意事项：

- 任务创建后状态为 "等待中"，需要手动执行
- 确保凭证ID对应的账号有效且Token未过期
- 保全金额必须为正数

### 2. 查看任务列表

任务列表显示以下信息：

- **ID**: 任务唯一标识
- **保全金额**: 格式化显示的保全金额（¥100,000.00）
- **状态**: 带颜色和图标的状态显示
  - ⏳ 等待中（橙色）
  - 🔄 执行中（蓝色）
  - ✅ 成功（绿色）
  - ⚠️ 部分成功（黄色）
  - ❌ 失败（红色）
- **成功/失败/总数**: 显示查询统计（例如：8 / 2 / 10）
- **成功率**: 百分比显示，根据成功率显示不同颜色
  - ≥80%: 绿色
  - ≥50%: 黄色
  - <50%: 红色
- **执行时长**: 显示任务执行时间
  - <60秒: 显示秒数（绿色）
  - ≥60秒: 显示分钟数（蓝色）
  - 执行中: 显示已执行时间（橙色）
- **创建时间**: 任务创建时间

#### 筛选功能：

- 按状态筛选
- 按创建时间筛选
- 按完成时间筛选

#### 搜索功能：

- 按任务ID搜索
- 按企业/法院ID搜索
- 按分类ID搜索

### 3. 查看任务详情

点击任务ID进入详情页面，可以查看：

#### 基本信息：
- ID
- 保全金额
- 企业/法院ID
- 分类ID
- 凭证ID

#### 任务状态：
- 状态
- 保险公司总数
- 成功查询数
- 失败查询数
- 成功率
- 错误信息（如果有）

#### 时间信息：
- 创建时间
- 开始时间
- 完成时间
- 执行时长

#### 报价汇总：

显示一个完整的报价表格，包含：

- **排名**: 按报价金额从低到高排序
- **保险公司**: 保险公司名称
- **报价金额**: 格式化显示的报价金额
  - 最低价会显示 🏆 标记
- **状态**: ✅ 成功 或 ❌ 失败

表格下方显示统计信息：
- 最低报价（绿色）
- 最高报价（红色）
- 平均报价（蓝色）

#### 保险公司报价列表：

以表格形式显示所有保险公司的详细报价信息：
- 保险公司名称
- 报价金额
- 状态
- 错误信息（如果查询失败）

### 4. 执行询价任务

#### 方法一：批量执行（推荐）

1. 在任务列表中，勾选要执行的任务
2. 在 "动作" 下拉菜单中选择 "执行选中的询价任务"
3. 点击 "执行" 按钮
4. 系统会自动执行所有选中的任务

#### 方法二：单个执行

1. 进入任务详情页面
2. 使用外部脚本或API调用执行任务

#### 执行条件：

- 只能执行状态为 "等待中" 或 "失败" 的任务
- 执行中或已完成的任务无法重复执行

#### 执行过程：

1. 系统检查Token是否有效
2. 获取保险公司列表
3. 并发查询所有保险公司报价
4. 保存报价结果
5. 更新任务状态

### 5. 重试失败任务

#### 步骤：

1. 在任务列表中，勾选要重试的任务
2. 在 "动作" 下拉菜单中选择 "重试失败的询价任务"
3. 点击 "执行" 按钮

#### 重试条件：

- 只能重试状态为 "失败" 或 "部分成功" 的任务

#### 重试操作：

- 重置任务状态为 "等待中"
- 清除错误信息
- 删除旧的报价记录
- 重置统计信息

#### 注意事项：

- 重试会删除之前的所有报价记录
- 重试后需要重新执行任务

### 6. 删除任务

可以删除不需要的任务：

1. 勾选要删除的任务
2. 在 "动作" 下拉菜单中选择 "删除所选的 财产保全询价"
3. 点击 "执行" 按钮
4. 确认删除

**注意**: 删除任务会同时删除所有关联的报价记录。

## 常见问题

### Q1: 任务执行失败，提示 Token 无效？

**A**: 需要先到 `/admin/automation/testcourt/` 使用测试工具登录并获取有效的Token。Token会自动保存到 `/admin/automation/courttoken/`。

### Q2: 如何查看最优报价？

**A**: 进入任务详情页面，查看 "报价汇总" 部分。最低价会显示 🏆 标记，并且报价按从低到高排序。

### Q3: 部分保险公司查询失败怎么办？

**A**: 这是正常现象。系统采用错误隔离机制，单个保险公司查询失败不会影响其他查询。可以查看失败的保险公司的错误信息，了解失败原因。

### Q4: 如何批量执行多个任务？

**A**: 在任务列表中勾选多个任务，然后使用 "执行选中的询价任务" 批量操作。系统会依次执行所有选中的任务。

### Q5: 任务执行时间过长？

**A**: 正常情况下，查询10个保险公司应该在10秒内完成。如果时间过长，可能是：
- 网络连接问题
- Token已过期
- 保险公司API响应慢

可以查看任务的错误信息了解具体原因。

### Q6: 如何导出报价结果？

**A**: 目前Admin后台不支持直接导出。可以使用API接口获取报价数据，然后导出为Excel或其他格式。

## 性能优化建议

1. **批量执行**: 使用批量操作一次执行多个任务，提高效率
2. **Token复用**: 确保Token有效，避免频繁登录
3. **定期清理**: 定期删除不需要的历史任务，保持数据库性能

## 安全注意事项

1. **权限控制**: 只有管理员可以访问Admin后台
2. **Token安全**: Token存储在数据库中，不要泄露给未授权用户
3. **数据保护**: 报价数据可能包含敏感信息，注意保护

## 相关文档

- [Token管理指南](./TOKEN_ADMIN_GUIDE.md)
- [API使用文档](../services/insurance/API_USAGE.md)
- [服务实现文档](../services/insurance/SERVICE_IMPLEMENTATION.md)

## 技术支持

如有问题，请联系技术支持团队或查看项目文档。
