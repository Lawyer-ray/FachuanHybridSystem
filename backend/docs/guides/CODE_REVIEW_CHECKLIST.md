# 代码审查清单

## 使用说明

本清单用于代码审查（Code Review），帮助 Reviewer 系统地检查代码质量。每次审查时，请逐项检查并在相应位置打勾。

## 快速检查清单（必查项）

在开始详细审查前，先快速检查这些关键项：

- [ ] API 层无业务逻辑
- [ ] Service 层使用依赖注入
- [ ] 跨模块使用 Protocol 接口
- [ ] 使用 select_related/prefetch_related 优化查询
- [ ] 权限检查在 Service 层
- [ ] 抛出自定义异常（不返回错误码）
- [ ] 有单元测试
- [ ] 有类型注解
- [ ] 有文档字符串
- [ ] 配置集中管理

## 详细检查清单

### 1. 架构检查

#### 1.1 分层架构

- [ ] **API 层职责**
  - [ ] 只负责请求/响应处理
  - [ ] 不包含业务逻辑（无 if/else 业务判断）
  - [ ] 不直接访问数据库（无 Model.objects.xxx）
  - [ ] 不执行权限检查（委托给 Service）
  - [ ] 不处理事务（在 Service 层使用 @transaction.atomic）

- [ ] **Service 层职责**
  - [ ] 封装所有业务逻辑
  - [ ] 使用 @transaction.atomic 管理事务
  - [ ] 执行权限检查
  - [ ] 抛出自定义业务异常
  - [ ] 不访问 HTTP request 对象（除非作为参数传递）
  - [ ] 不返回 HTTP 响应对象

- [ ] **Model 层职责**
  - [ ] 只包含数据定义
  - [ ] 只有简单的属性方法（@property）
  - [ ] 不包含复杂业务逻辑
  - [ ] 不调用其他模块的 Model

#### 1.2 依赖注入

- [ ] **构造函数注入**
  - [ ] Service 类通过构造函数注入依赖
  - [ ] 依赖声明为接口类型（Protocol）
  - [ ] 没有在 Service 内部直接创建依赖
  - [ ] 没有使用全局变量存储状态

- [ ] **依赖关系**
  - [ ] 依赖关系清晰且可测试
  - [ ] 在 API 层组装依赖
  - [ ] 测试时可以注入 Mock 对象

#### 1.3 接口解耦

- [ ] **Protocol 使用**
  - [ ] 跨模块通信使用 Protocol 接口
  - [ ] Protocol 定义在 apps/core/interfaces.py
  - [ ] 使用 DTO 传递数据，不直接传递 Model
  - [ ] 没有循环依赖

- [ ] **DTO 定义**
  - [ ] DTO 使用 dataclass 定义
  - [ ] DTO 有 from_model 方法
  - [ ] DTO 包含必要的字段和类型注解

### 2. 代码质量检查

#### 2.1 命名规范

- [ ] **命名约定**
  - [ ] 类名使用 PascalCase
  - [ ] 函数名和变量名使用 snake_case
  - [ ] 常量使用 UPPER_CASE
  - [ ] 私有方法使用 `_` 前缀
  - [ ] 名称具有描述性，能够表达意图

#### 2.2 类型注解

- [ ] **类型注解完整性**
  - [ ] 所有函数参数都有类型注解
  - [ ] 所有函数都有返回值类型注解
  - [ ] 复杂类型使用 typing 模块（List, Dict, Optional）
  - [ ] Protocol 接口方法都有完整的类型注解

#### 2.3 文档字符串

- [ ] **文档完整性**
  - [ ] 所有公共类都有文档字符串
  - [ ] 所有公共方法都有文档字符串
  - [ ] 文档字符串包含参数说明（Args）
  - [ ] 文档字符串包含返回值说明（Returns）
  - [ ] 文档字符串包含异常说明（Raises）
  - [ ] 使用中文编写文档字符串

#### 2.4 代码复杂度

- [ ] **复杂度控制**
  - [ ] 函数长度不超过 50 行
  - [ ] 嵌套层级不超过 3 层
  - [ ] 圈复杂度不超过 10
  - [ ] 复杂逻辑提取为私有方法

### 3. 性能检查

#### 3.1 数据库查询优化

- [ ] **预加载优化**
  - [ ] 使用 select_related 预加载外键关系
  - [ ] 使用 prefetch_related 预加载多对多关系
  - [ ] 没有 N+1 查询问题
  - [ ] 使用 only/defer 优化字段查询
  - [ ] 使用 annotate 在数据库层面计算聚合数据

- [ ] **查询验证**
  - [ ] 在循环外执行查询
  - [ ] 使用 QuerySet 而非列表
  - [ ] 避免在循环中访问关联对象

#### 3.2 批量操作

- [ ] **批量操作使用**
  - [ ] 使用 bulk_create 批量创建
  - [ ] 使用 bulk_update 批量更新
  - [ ] 使用 update() 批量更新字段
  - [ ] 没有在循环中执行数据库操作

#### 3.3 缓存使用

- [ ] **缓存策略**
  - [ ] 耗时计算使用缓存
  - [ ] 缓存键命名规范
  - [ ] 设置合理的缓存过期时间
  - [ ] 缓存失效策略清晰

### 4. 安全检查

#### 4.1 权限控制

- [ ] **权限检查**
  - [ ] 所有 Service 方法都有权限检查
  - [ ] 权限检查在 Service 层实现
  - [ ] 权限检查失败抛出 PermissionDenied 异常
  - [ ] 列表查询使用权限过滤

#### 4.2 输入验证

- [ ] **数据验证**
  - [ ] 使用 Pydantic Schema 验证输入
  - [ ] 验证失败抛出 ValidationException
  - [ ] 不信任任何用户输入
  - [ ] 敏感操作有二次确认

#### 4.3 SQL 注入防护

- [ ] **SQL 安全**
  - [ ] 使用 ORM 而非原生 SQL
  - [ ] 原生 SQL 使用参数化查询
  - [ ] 没有字符串拼接 SQL
  - [ ] 用户输入经过验证和转义

#### 4.4 敏感信息保护

- [ ] **信息安全**
  - [ ] 密码使用哈希存储
  - [ ] Token 加密存储
  - [ ] 日志不记录敏感信息（密码、Token、信用卡号）
  - [ ] 敏感配置使用环境变量

### 5. 异常处理检查

#### 5.1 异常使用

- [ ] **异常类型**
  - [ ] Service 层抛出自定义业务异常
  - [ ] 异常继承自 BusinessException
  - [ ] 异常包含清晰的错误消息
  - [ ] 异常包含错误码和结构化错误信息

#### 5.2 异常处理

- [ ] **异常处理规范**
  - [ ] API 层依赖全局异常处理器
  - [ ] 不捕获通用 Exception（除非重新抛出）
  - [ ] 异常记录日志（包含上下文信息）
  - [ ] 不使用异常控制正常流程

### 6. 测试检查

#### 6.1 测试覆盖

- [ ] **测试完整性**
  - [ ] Service 层有单元测试
  - [ ] 核心业务逻辑有测试覆盖
  - [ ] 测试覆盖率达到目标（Service 80%+）
  - [ ] 边界条件有测试
  - [ ] 异常场景有测试

#### 6.2 测试质量

- [ ] **测试规范**
  - [ ] 测试命名清晰，说明测试内容
  - [ ] 使用 AAA 模式（Arrange, Act, Assert）
  - [ ] 使用 Mock 隔离依赖
  - [ ] 测试独立，不依赖其他测试
  - [ ] 测试数据使用 Factory 生成

#### 6.3 Property-Based Testing

- [ ] **PBT 测试**
  - [ ] 通用属性有 PBT 测试
  - [ ] PBT 测试标注了对应的 Property
  - [ ] PBT 测试引用了需求编号
  - [ ] PBT 测试运行至少 100 次迭代

### 7. 配置管理检查

#### 7.1 配置集中化

- [ ] **配置管理**
  - [ ] 配置定义在 apps/core/config.py
  - [ ] 使用 dataclass 定义配置类
  - [ ] 敏感配置使用环境变量
  - [ ] 配置有默认值
  - [ ] 配置不散落在代码中

#### 7.2 配置验证

- [ ] **配置验证**
  - [ ] 配置在启动时验证
  - [ ] 验证失败抛出清晰的错误
  - [ ] 配置有文档说明

### 8. 日志检查

#### 8.1 日志使用

- [ ] **日志规范**
  - [ ] 使用结构化日志（extra 参数）
  - [ ] 日志级别使用正确（debug, info, warning, error）
  - [ ] 异常记录包含堆栈信息（exc_info=True）
  - [ ] 日志包含足够的上下文信息

#### 8.2 日志安全

- [ ] **日志安全**
  - [ ] 日志不记录密码
  - [ ] 日志不记录 Token
  - [ ] 日志不记录完整的信用卡号
  - [ ] 敏感信息已脱敏

### 9. 代码风格检查

#### 9.1 PEP 8 规范

- [ ] **代码风格**
  - [ ] 使用 4 空格缩进
  - [ ] 行长度不超过 120 字符
  - [ ] 导入语句按标准库、第三方库、本地库分组
  - [ ] 函数和类之间有适当的空行

#### 9.2 注释规范

- [ ] **注释质量**
  - [ ] 注释解释"为什么"而非"是什么"
  - [ ] 复杂逻辑有注释说明
  - [ ] 没有注释掉的代码（应该删除）
  - [ ] TODO 注释包含负责人和日期

## 常见问题检查

### 反模式识别

- [ ] **架构反模式**
  - [ ] 没有在 API 层写业务逻辑
  - [ ] 没有直接创建依赖（使用依赖注入）
  - [ ] 没有循环依赖
  - [ ] 没有 N+1 查询
  - [ ] 没有返回错误码（抛出异常）

- [ ] **代码反模式**
  - [ ] 没有在 Model 中写复杂业务逻辑
  - [ ] 没有使用全局变量存储状态
  - [ ] 没有忽略异常或只打印不记录日志
  - [ ] 没有在循环中执行数据库操作
  - [ ] 没有配置硬编码在代码中

## 审查意见模板

### 严重问题（必须修改）

```
🔴 严重问题：[问题描述]

位置：[文件名:行号]

问题：[详细说明问题]

影响：[说明问题的影响]

建议：[提供具体的修改建议]

参考：[相关文档或代码示例]
```

### 建议改进（建议修改）

```
🟡 建议改进：[问题描述]

位置：[文件名:行号]

当前实现：[描述当前实现]

建议：[提供改进建议]

理由：[说明改进的好处]
```

### 优秀实践（值得学习）

```
🟢 优秀实践：[亮点描述]

位置：[文件名:行号]

亮点：[说明优秀之处]

值得学习：[说明为什么值得学习]
```

## 审查流程

1. **准备阶段**
   - [ ] 阅读 PR 描述和相关 Issue
   - [ ] 了解变更的背景和目的
   - [ ] 准备代码审查清单

2. **快速检查**
   - [ ] 使用快速检查清单进行初步审查
   - [ ] 识别明显的问题

3. **详细审查**
   - [ ] 逐项检查详细清单
   - [ ] 记录发现的问题
   - [ ] 提供改进建议

4. **反馈阶段**
   - [ ] 使用审查意见模板提供反馈
   - [ ] 区分严重问题和建议改进
   - [ ] 指出优秀实践

5. **跟进阶段**
   - [ ] 确认问题已修复
   - [ ] 验证改进效果
   - [ ] 批准或请求再次审查

## 审查标准

### 必须通过的条件

- ✅ 所有严重问题已修复
- ✅ 架构分层正确
- ✅ 有单元测试且通过
- ✅ 代码风格符合规范
- ✅ 没有明显的性能问题
- ✅ 没有安全漏洞

### 建议改进的条件

- 💡 代码可读性可以提升
- 💡 测试覆盖率可以提高
- 💡 性能可以进一步优化
- 💡 文档可以更完善

## 工具支持

### 自动化检查工具

- **代码风格**：flake8, black
- **类型检查**：mypy
- **测试覆盖率**：pytest-cov
- **代码质量**：SonarQube

### 手动检查重点

- 架构设计
- 业务逻辑正确性
- 异常处理
- 性能优化
- 安全性

## 参考资源

- **架构规范**：`.kiro/steering/django-python-expert.md`
- **设计文档**：`.kiro/specs/backend-architecture-refactoring/design.md`
- **培训文档**：`backend/docs/ARCHITECTURE_TRAINING.md`
- **ADR 文档**：`backend/docs/adr/`

## 审查记录

**审查人**：_______________

**审查日期**：_______________

**PR 编号**：_______________

**审查结果**：
- [ ] 批准（Approved）
- [ ] 请求修改（Request Changes）
- [ ] 评论（Comment）

**主要问题**：
1. _______________
2. _______________
3. _______________

**改进建议**：
1. _______________
2. _______________
3. _______________

**优秀实践**：
1. _______________
2. _______________
3. _______________
