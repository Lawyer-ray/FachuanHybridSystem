# 代码审查流程

## 流程概述

代码审查（Code Review）是确保代码质量的重要环节。本文档定义了标准的代码审查流程，确保所有代码变更都经过充分的审查。

## 代码审查原则

### 1. 核心原则

- **建设性**：提供建设性的反馈，而非批评
- **及时性**：在 24 小时内完成审查
- **全面性**：使用代码审查清单系统检查
- **学习性**：审查是双向学习的机会
- **尊重性**：尊重作者的工作，礼貌沟通

### 2. 审查目标

- 确保代码符合架构规范
- 发现潜在的 bug 和性能问题
- 提高代码可读性和可维护性
- 分享知识和最佳实践
- 保持代码库的一致性

## 审查流程

### 阶段 1：提交 PR（开发者）

#### 1.1 准备工作

**在提交 PR 前，开发者应该**：

- [ ] 运行所有测试并确保通过
- [ ] 运行代码风格检查（flake8, black）
- [ ] 运行类型检查（mypy）
- [ ] 自查代码审查清单
- [ ] 更新相关文档
- [ ] 添加必要的注释

#### 1.2 PR 描述

**PR 描述应该包含**：

```markdown
## 变更描述

[简要描述本次变更的目的和内容]

## 相关 Issue

Closes #[Issue 编号]

## 变更类型

- [ ] 新功能（Feature）
- [ ] Bug 修复（Bug Fix）
- [ ] 重构（Refactoring）
- [ ] 性能优化（Performance）
- [ ] 文档更新（Documentation）
- [ ] 测试（Testing）

## 变更清单

- [x] 添加了 XXX 功能
- [x] 修复了 XXX bug
- [x] 重构了 XXX 模块
- [x] 优化了 XXX 查询

## 测试

- [x] 添加了单元测试
- [x] 添加了集成测试
- [x] 所有测试通过
- [x] 测试覆盖率达标

## 架构检查

- [x] API 层无业务逻辑
- [x] Service 层使用依赖注入
- [x] 使用 select_related/prefetch_related
- [x] 抛出自定义异常
- [x] 有类型注解和文档字符串

## 截图（如适用）

[添加截图或 GIF]

## 其他说明

[其他需要说明的内容]
```

#### 1.3 自查清单

**提交前自查**：

- [ ] 代码符合架构规范
- [ ] 没有明显的性能问题
- [ ] 没有安全漏洞
- [ ] 测试覆盖充分
- [ ] 文档已更新
- [ ] 提交信息清晰

### 阶段 2：分配 Reviewer

#### 2.1 Reviewer 选择

**选择标准**：

- 熟悉相关模块的开发者
- 至少 1 位 Reviewer
- 对于重要变更，建议 2 位 Reviewer

**自动分配**：

- 使用 CODEOWNERS 文件自动分配
- 或手动指定 Reviewer

#### 2.2 Reviewer 职责

**Reviewer 应该**：

- 在 24 小时内开始审查
- 使用代码审查清单
- 提供建设性的反馈
- 区分严重问题和建议改进
- 指出优秀实践

### 阶段 3：代码审查（Reviewer）

#### 3.1 审查准备

**开始审查前**：

- [ ] 阅读 PR 描述和相关 Issue
- [ ] 了解变更的背景和目的
- [ ] 准备代码审查清单
- [ ] 拉取代码到本地（如需要）

#### 3.2 快速检查

**使用快速检查清单**：

- [ ] API 层无业务逻辑
- [ ] Service 层使用依赖注入
- [ ] 跨模块使用 Protocol 接口
- [ ] 使用 select_related/prefetch_related
- [ ] 权限检查在 Service 层
- [ ] 抛出自定义异常
- [ ] 有单元测试
- [ ] 有类型注解
- [ ] 有文档字符串
- [ ] 配置集中管理

#### 3.3 详细审查

**使用详细检查清单**：

参考 `backend/docs/CODE_REVIEW_CHECKLIST.md`

**审查重点**：

1. **架构设计**
   - 分层架构是否正确
   - 依赖注入是否使用
   - 接口解耦是否合理

2. **代码质量**
   - 命名是否清晰
   - 类型注解是否完整
   - 文档字符串是否充分
   - 代码复杂度是否合理

3. **性能**
   - 是否有 N+1 查询
   - 是否使用批量操作
   - 是否有缓存策略

4. **安全**
   - 权限检查是否完整
   - 输入验证是否充分
   - 是否有 SQL 注入风险
   - 敏感信息是否保护

5. **测试**
   - 测试覆盖是否充分
   - 测试质量是否高
   - 是否有 PBT 测试

#### 3.4 提供反馈

**反馈类型**：

**🔴 严重问题（必须修改）**：
```
🔴 严重问题：API 层包含业务逻辑

位置：apps/resources/api/resource_api.py:25

问题：在 API 层直接进行权限检查和业务验证

影响：违反架构原则，代码难以测试和复用

建议：将权限检查和业务验证移至 Service 层

参考：.kiro/steering/django-python-expert.md - API 层规范
```

**🟡 建议改进（建议修改）**：
```
🟡 建议改进：可以优化查询性能

位置：apps/resources/services/resource_service.py:45

当前实现：在循环中访问 contract.name

建议：使用 select_related('contract') 预加载

理由：避免 N+1 查询，提升性能
```

**🟢 优秀实践（值得学习）**：
```
🟢 优秀实践：使用依赖注入

位置：apps/resources/services/resource_service.py:10

亮点：通过构造函数注入 IDependencyService，提高了可测试性

值得学习：这是标准的依赖注入模式，值得其他模块学习
```

**💬 问题讨论**：
```
💬 问题：这里为什么使用 prefetch_related 而不是 select_related？

位置：apps/resources/services/resource_service.py:50

说明：我理解 parties 是多对多关系，但想确认一下是否有其他考虑
```

#### 3.5 审查结果

**审查结果类型**：

1. **✅ 批准（Approved）**
   - 代码质量良好
   - 没有严重问题
   - 可以合并

2. **🔄 请求修改（Request Changes）**
   - 存在严重问题
   - 必须修改后才能合并
   - 需要再次审查

3. **💬 评论（Comment）**
   - 提供建议和讨论
   - 不阻止合并
   - 供作者参考

### 阶段 4：修改和讨论（开发者）

#### 4.1 处理反馈

**开发者应该**：

- [ ] 认真阅读所有反馈
- [ ] 修复所有严重问题
- [ ] 考虑建议改进
- [ ] 回复讨论问题
- [ ] 更新代码

#### 4.2 回复反馈

**回复模板**：

```markdown
## 已修复

✅ 已将权限检查移至 Service 层
✅ 已使用 select_related 优化查询
✅ 已添加单元测试

## 讨论

关于使用 prefetch_related 的问题：
[解释原因]

## 不采纳的建议

关于 XXX 的建议暂不采纳，原因是：
[说明原因]
```

#### 4.3 请求再次审查

**修改完成后**：

- [ ] 推送新的提交
- [ ] 回复所有反馈
- [ ] 请求再次审查
- [ ] 标记已解决的讨论

### 阶段 5：再次审查（Reviewer）

#### 5.1 验证修改

**Reviewer 应该**：

- [ ] 检查所有严重问题是否已修复
- [ ] 验证修改是否正确
- [ ] 确认测试是否通过
- [ ] 检查是否引入新问题

#### 5.2 最终决定

**决定类型**：

1. **✅ 批准合并**
   - 所有问题已解决
   - 代码质量良好
   - 可以合并

2. **🔄 继续修改**
   - 仍有问题需要修复
   - 需要再次审查

### 阶段 6：合并代码

#### 6.1 合并前检查

**合并前确认**：

- [ ] 至少 1 位 Reviewer 批准
- [ ] 所有测试通过
- [ ] 没有冲突
- [ ] CI/CD 通过

#### 6.2 合并策略

**合并方式**：

1. **Squash and Merge**（推荐）
   - 将多个提交合并为一个
   - 保持主分支历史清晰
   - 适用于大多数情况

2. **Merge Commit**
   - 保留所有提交历史
   - 适用于重要的功能分支

3. **Rebase and Merge**
   - 线性历史
   - 适用于简单的变更

#### 6.3 合并后

**合并后操作**：

- [ ] 删除功能分支
- [ ] 关闭相关 Issue
- [ ] 通知相关人员
- [ ] 监控生产环境

## 审查标准

### 1. 必须通过的条件

**硬性要求**：

- ✅ 所有严重问题已修复
- ✅ 架构分层正确
- ✅ 有单元测试且通过
- ✅ 代码风格符合规范
- ✅ 没有明显的性能问题
- ✅ 没有安全漏洞

### 2. 建议改进的条件

**软性要求**：

- 💡 代码可读性可以提升
- 💡 测试覆盖率可以提高
- 💡 性能可以进一步优化
- 💡 文档可以更完善

## 特殊情况处理

### 1. 紧急修复

**流程简化**：

- 可以只有 1 位 Reviewer
- 审查时间缩短到 2 小时
- 重点检查安全和正确性
- 合并后补充完整审查

### 2. 大型重构

**特殊处理**：

- 需要 2 位以上 Reviewer
- 分阶段审查
- 重点关注架构设计
- 充分讨论和测试

### 3. 文档更新

**简化流程**：

- 可以快速审查
- 重点检查准确性和完整性
- 可以直接合并

## 审查指标

### 1. 效率指标

- **审查响应时间**：< 24 小时
- **审查完成时间**：< 48 小时
- **修改轮次**：< 3 轮

### 2. 质量指标

- **严重问题发现率**：> 80%
- **代码质量提升**：持续改进
- **知识分享**：每次审查至少 1 个学习点

### 3. 参与指标

- **审查参与率**：100%
- **反馈质量**：建设性和具体
- **学习效果**：团队能力提升

## 工具支持

### 1. 代码审查工具

- **GitHub PR**：主要审查平台
- **代码审查清单**：系统检查
- **自动化检查**：CI/CD 集成

### 2. 自动化检查

- **flake8**：代码风格
- **mypy**：类型检查
- **pytest**：测试运行
- **coverage**：测试覆盖率

### 3. 辅助工具

- **Django Debug Toolbar**：性能分析
- **SonarQube**：代码质量
- **Git Diff**：变更对比

## 最佳实践

### 1. 作为开发者

**提交 PR 时**：
- 保持 PR 小而专注
- 提供清晰的描述
- 自查代码审查清单
- 及时回复反馈

**接收反馈时**：
- 保持开放心态
- 认真对待每条反馈
- 积极讨论和学习
- 感谢 Reviewer 的时间

### 2. 作为 Reviewer

**审查时**：
- 及时响应
- 提供建设性反馈
- 区分严重问题和建议
- 指出优秀实践

**反馈时**：
- 使用礼貌的语言
- 提供具体的建议
- 解释原因和影响
- 提供参考资源

### 3. 团队协作

**沟通**：
- 使用清晰的语言
- 避免模糊的表述
- 及时回复讨论
- 保持专业和尊重

**学习**：
- 将审查视为学习机会
- 分享知识和经验
- 记录最佳实践
- 持续改进

## 参考资源

- **代码审查清单**：`backend/docs/CODE_REVIEW_CHECKLIST.md`
- **架构规范**：`.kiro/steering/django-python-expert.md`
- **最佳实践**：`backend/docs/REFACTORING_BEST_PRACTICES.md`
- **培训文档**：`backend/docs/ARCHITECTURE_TRAINING.md`

## 联系方式

**技术支持**：
- 审查问题：联系技术负责人
- 流程改进：提交建议
- 培训咨询：联系培训负责人

**反馈渠道**：
- 提交 Issue
- 发起讨论
- 更新文档
