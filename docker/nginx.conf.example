# ============================================================
# 法穿案件管理系统 - Nginx 反向代理配置示例
# ============================================================
# 用于生产环境的 HTTPS 反向代理配置
# 
# 使用说明：
# 1. 复制此文件到 /etc/nginx/sites-available/fachuang
# 2. 修改 server_name 为你的域名
# 3. 配置 SSL 证书路径
# 4. 创建软链接: ln -s /etc/nginx/sites-available/fachuang /etc/nginx/sites-enabled/
# 5. 测试配置: nginx -t
# 6. 重载配置: nginx -s reload
#
# Requirements: 6.3, 6.7, 12.3
# ============================================================

# 上游服务器定义
upstream fachuang_backend {
    # Docker 容器地址（根据实际部署调整）
    server 127.0.0.1:8000;
    
    # 如果使用 Docker 网络，可以使用容器名
    # server fachuang-backend:8000;
    
    # 负载均衡配置（多实例部署时使用）
    # server 127.0.0.1:8001;
    # server 127.0.0.1:8002;
    
    # 连接保持
    keepalive 32;
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;
    
    # Let's Encrypt 证书验证路径
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    
    # 其他请求重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 主配置
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # ============================================================
    # SSL 证书配置
    # ============================================================
    # 使用 Let's Encrypt 证书（推荐）
    # 获取证书: certbot certonly --webroot -w /var/www/certbot -d your-domain.com
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL 会话配置
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    
    # SSL 协议和加密套件（现代配置）
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # HSTS（HTTP 严格传输安全）
    # 警告：启用后浏览器会强制使用 HTTPS，请确保 HTTPS 配置正确
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # ============================================================
    # 安全头配置
    # ============================================================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # CSP（内容安全策略）- 根据实际需求调整
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';" always;
    
    # ============================================================
    # 日志配置
    # ============================================================
    access_log /var/log/nginx/fachuang_access.log;
    error_log /var/log/nginx/fachuang_error.log;
    
    # ============================================================
    # 客户端配置
    # ============================================================
    # 最大请求体大小（文件上传限制）
    client_max_body_size 100M;
    
    # 客户端超时
    client_body_timeout 60s;
    client_header_timeout 60s;
    
    # ============================================================
    # 静态文件服务
    # ============================================================
    # Django 静态文件
    location /static/ {
        alias /path/to/staticfiles/;  # 修改为实际路径
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # 如果使用 Docker Volume，可以挂载到宿主机
        # alias /var/lib/docker/volumes/fachuang-static/_data/;
        
        # Gzip 压缩
        gzip_static on;
    }
    
    # 媒体文件（用户上传）
    location /media/ {
        alias /path/to/media/;  # 修改为实际路径
        expires 7d;
        add_header Cache-Control "public";
        
        # 如果使用 Docker Volume
        # alias /var/lib/docker/volumes/fachuang-media/_data/;
    }
    
    # ============================================================
    # API 和应用代理
    # ============================================================
    location / {
        proxy_pass http://fachuang_backend;
        
        # 代理头设置
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 120s;  # 长请求需要更长超时
        
        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # 错误页面
        proxy_intercept_errors on;
    }
    
    # ============================================================
    # 健康检查端点（可选：不记录日志）
    # ============================================================
    location /api/v1/health {
        proxy_pass http://fachuang_backend;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 不记录健康检查日志
        access_log off;
    }
    
    # ============================================================
    # 错误页面
    # ============================================================
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}

# ============================================================
# 可选：使用 Docker Compose 部署 Nginx
# ============================================================
# 如果你想将 Nginx 也放入 Docker Compose，可以添加以下服务：
#
# services:
#   nginx:
#     image: nginx:alpine
#     container_name: fachuang-nginx
#     restart: unless-stopped
#     ports:
#       - "80:80"
#       - "443:443"
#     volumes:
#       - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
#       - ./certbot/conf:/etc/letsencrypt:ro
#       - ./certbot/www:/var/www/certbot:ro
#       - static_data:/var/www/static:ro
#       - media_data:/var/www/media:ro
#     depends_on:
#       - backend
#     networks:
#       - fachuang-network
